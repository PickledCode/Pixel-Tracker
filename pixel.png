<?php
if (!isset($_GET['e'])) {
	readfile('frown.png'); // TODO: put an actual frowny file here
	exit();
}

require_once dirname(__FILE__) . '/_classes/_include.php';

$decoder = new Encryption('iHateMonkeys');
$encoder = new Encryption('iLoveMonkeys'); // encoder for cancelation link

$email = $decoder->decrypt($_GET['e']);
$emailList = new EmailList('_secret/blocked_emails.dat');

if (!$emailList->containsEmail($email)) {
	$ipAddress = $_SERVER['REMOTE_ADDR'];
	$hostName = $_SERVER['REMOTE_HOST'];
	$urlAddr = $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
	
	$encE = $encoder->encrypt($email);
	$unsubAddr = $_SERVER['HTTP_HOST'] . '/pixel.blocker.php?e=' . urlencode($encE);
	$msg = sprintf("Someone has viewed your custom image from %s\n\n" .
			"IP: %s\nHostname: %s\n\n" .
			"If you did not subscribe to get these messages, you can cancel email\n" .
			"notifications by visiting the URL: %s\n\nThank you,\nPixel Tracker team",
			$urlAddr, $ipAddress, $hostName, $unsubAddr
	);
	mail($email, 'Hit from Pixel Tracker', $msg);
	echo 'Sent message to ' . $email;
} else {
	echo 'Sucker is blacklisted.';
	// TODO: note this in the log.
}

$emailList->closeFile();
// header('Content-Type: image/png');
// readfile('pixel.secret.png.txt');

?>
