<?php

if (!isset($_GET['e'])) {
	readfile('frown.png'); // TODO: put an actual frowny file here
	exit();
}

require_once('_classes/_include.php');

$decoder = new Encryption('iHateMonkeys');
$encoder = new Encryption('iLoveMonkeys');
$email = $decoder->decrypt($_GET['e']);
$emailList = new EmailList('_secret/blocked_emails.dat');
if (!$emailList->containsEmail($email)) {
	$ipAddress = $_SERVER['REMOTE_ADDR'];
	$hostName = $_SERVER['REMOTE_HOST'];
	$urlAddr = $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
	
	$encE = $encoder->encrypt($email);
	$unsubAddr = $_SERVER['HTTP_HOST'] . '/pixel.blocker.php?e=' . urlencode($encE);
	$msg = sprintf("Someone has viewed your custom image from %s\n\n" .
			"IP: %s\nHostname: %s\n\n" .
			"If you did not subscribe to get these messages, you can cancel email\n" .
			"notifications by visiting the URL: %s\n\nThank you,\nPixel Tracker team",
			$urlAddr, $ipAddress, $hostName, $ubsubAddr
	);
	mail($email, 'Hit from Pixel Tracker', $msg);
} else {
	// TODO: note this in the log.
}
$emailList->closeFile();
readfile('pixel.secret.png.txt');

?>
